<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy {{ crypto.name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
  {% include "gasfee/header.html" %}

  <div class="container mx-auto p-6 mt-20">
    <div class="max-w-2xl mx-auto bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4">Buy {{ crypto.name }} ({{ crypto.symbol }})</h2>
      
      <!-- Exchange Rate Display -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-4">
          <img src="{{ crypto.logo.url }}" alt="{{ crypto.name }} logo" class="w-12 h-12 rounded-full">
          <div>
            <p class="text-gray-400">Exchange Rate (USDT/NGN):</p>
            <p class="text-lg font-bold text-green-400">₦{{ exchange_rate }}</p>
          </div>
        </div>
      </div>

      <!-- Purchase Form -->
      <form id="buyCryptoForm"> 
        {% csrf_token %}

        <!-- Amount Input with Currency Dropdown -->
        <div class="mb-4">
          <label class="block text-gray-400 mb-2">Amount</label>
          <div class="relative flex">
            <input type="number" name="amount" id="amountInput" step="0.0001" required
                   class="w-full p-2 bg-gray-700 rounded-l border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select name="currency" id="currencySelect"
                    class="bg-gray-700 text-white p-2 border-l border-gray-600 rounded-r">
              <option value="ngn">NGN</option>
              <option value="usdt">USDT</option>
              <option value="{{ crypto.symbol|lower }}">{{ crypto.symbol|upper }}</option>
            </select>
          </div>
        </div>

        <!-- Wallet Address Input -->
        <div class="mb-4">
          <label for="walletAddress" class="block text-gray-400 mb-2">Your Crypto Wallet Address</label>
          <input type="text" name="wallet_address" id="walletAddress" required
                 placeholder="Paste your {{ crypto.symbol }} wallet address here"
                 class="w-full p-2 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Total Cost & Amount Display -->
        <div class="flex justify-between items-center mb-4">
          <div>
            <p class="text-gray-400">Total Cost (<span id="inputCurrency">{{ crypto.symbol }}</span>):</p>
            <p id="totalCost" class="text-2xl font-bold text-blue-400">₦0.00</p>
          </div>
          <div>
            <p class="text-gray-400">Crypto Received:</p>
            <p id="cryptoReceived" class="text-2xl font-bold text-green-400">0 {{ crypto.symbol }}</p>
          </div>
        </div>

        <!-- Confirm Purchase Button -->
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg shadow">
          Confirm Purchase
        </button>
      </form>
      
      <div class="mt-6 text-center">
        <a href="{% url 'asset_list' %}" class="text-blue-400 hover:underline">Back to Cryptocurrencies</a>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" 
       class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
       style="z-index: 1000;">
    <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg relative">
      <h3 class="text-xl font-semibold">Purchase Successful!</h3>
      <p id="successMessage">Your purchase is processing.</p>
      <p>Check your wallet in the next few minutes.</p>
      <p>You can submit another if you want.</p>
      <button id="closeModal" class="mt-4 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">OK</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
        const amountInput = document.getElementById("amountInput");
        const currencySelect = document.getElementById("currencySelect");
        const totalCostDisplay = document.getElementById("totalCost");
        const cryptoReceivedDisplay = document.getElementById("cryptoReceived");

        const cryptoPrice = parseFloat("{{ crypto_price }}"); // Live price from backend
        const exchangeRate = parseFloat("{{ exchange_rate }}");

        if (isNaN(cryptoPrice) || cryptoPrice <= 0) {
            console.error("🚨 Invalid crypto price:", cryptoPrice);
        }
        if (isNaN(exchangeRate) || exchangeRate <= 0) {
            console.error("🚨 Invalid exchange rate:", exchangeRate);
        }

        function updateCostAndCrypto() {
            const amount = parseFloat(amountInput.value) || 0;
            const currency = currencySelect.value;

            let totalCostNgn = 0;
            let cryptoReceived = 0;

            if (currency === "ngn") {
                const amountInUsdt = amount / exchangeRate;
                cryptoReceived = amountInUsdt / cryptoPrice;
                totalCostNgn = amount;
            } else if (currency === "usdt") {
                cryptoReceived = amount / cryptoPrice;
                totalCostNgn = amount * exchangeRate;
            } else {  // crypto.symbol
                cryptoReceived = amount;
                totalCostNgn = (amount * cryptoPrice) * exchangeRate;
            }

            totalCostNgn = isFinite(totalCostNgn) ? totalCostNgn : 0;
            cryptoReceived = isFinite(cryptoReceived) ? cryptoReceived : 0;

            totalCostDisplay.innerText = `₦${totalCostNgn.toFixed(2)}`;
            cryptoReceivedDisplay.innerText = `${cryptoReceived.toFixed(6)} {{ crypto.symbol }}`;
            document.getElementById("inputCurrency").innerText = currency.toUpperCase();
        }

        amountInput.addEventListener("input", updateCostAndCrypto);
        currencySelect.addEventListener("change", updateCostAndCrypto);

        const buyCryptoForm = document.getElementById("buyCryptoForm");
        const successModal = document.getElementById("successModal");
        const closeModal = document.getElementById("closeModal");

        buyCryptoForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const formData = new FormData(buyCryptoForm);

            fetch("{% url 'buy_crypto' crypto.id %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest"
                },
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("📨 Response Data:", data);
                if (data.success) {
                    const cryptoText = data.message.split("Your ")[1].split(" purchase")[0];
                    const [cryptoAmount, cryptoSymbol] = cryptoText.split(" ");
                    const inputAmount = parseFloat(formData.get("amount")).toFixed(2);
                    const inputCurrency = formData.get("currency").toUpperCase();
                    const totalCostFormatted = inputCurrency === "NGN" ? `₦${inputAmount}` : `${inputAmount} ${inputCurrency}`;

                    document.getElementById("successMessage").innerText = 
                        `Congrats! Your purchase of ${totalCostFormatted} worth of ${cryptoAmount} ${cryptoSymbol} is processing and will hit your provided wallet shortly`;
                    successModal.style.display = "flex";
                    successModal.style.opacity = "1";
                } else {
                    console.log("❌ Purchase failed:", data);
                    alert(data.error || "Something went wrong. Try again.");
                }
            })
            .catch(error => console.error("🚨 Fetch Error:", error));
        });

        closeModal.addEventListener("click", function () {
            successModal.style.display = "none";
            window.location.href = "{% url 'asset_list' %}";
        });
    });
  </script>
</body>
</html>